<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Test - Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: monospace; background: #1a1a1a; color: #0f0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: #000; border: 2px solid #0f0; padding: 15px; border-radius: 5px; }
        .video-box { background: #111; border: 2px solid #333; padding: 10px; border-radius: 5px; margin: 10px 0; }
        video { width: 100%; height: auto; background: #000; border: 1px solid #333; }
        button { background: #0f0; color: #000; border: none; padding: 8px 15px; margin: 5px 5px 5px 0; cursor: pointer; font-family: monospace; }
        button:hover { background: #0d0; }
        .log { background: #111; border: 1px solid #333; padding: 10px; margin: 10px 0; height: 200px; overflow-y: auto; font-size: 11px; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
        .status { padding: 10px; margin: 10px 0; border-left: 3px solid; }
        .status.ok { background: #001000; border-color: #0f0; }
        .status.error { background: #100000; border-color: #f00; }
        .status.info { background: #000810; border-color: #0ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Stream Test - Viewer Mode</h1>
        
        <div class="grid">
            <div class="panel">
                <h2>üì° Connection</h2>
                <div id="connectionStatus" class="status info">Disconnected</div>
                <button onclick="connectTest()">Connect to Broadcaster</button>
                <button onclick="disconnectTest()">Disconnect</button>
                
                <h3 style="margin-top: 20px;">Input</h3>
                <label>Room ID:</label>
                <input type="text" id="roomId" placeholder="e.g., test" value="test" style="width: 100%; padding: 5px; margin: 5px 0;">
                
                <label style="display: block; margin-top: 10px;">Client ID:</label>
                <input type="text" id="clientId" placeholder="Auto-generated" readonly style="width: 100%; padding: 5px; margin: 5px 0; background: #111;">

                <div id="wsLog" class="log"></div>
            </div>

            <div class="panel">
                <h2>üìπ Video Stream</h2>
                <div id="streamStatus" class="status info">No stream</div>
                <div class="video-box">
                    <video id="remoteVideo" autoplay playsinline muted controls></video>
                </div>
                <button onclick="testVideoProperties()">Test Video Properties</button>
                <button onclick="toggleMuted()">Toggle Muted</button>
                
                <h3 style="margin-top: 20px;">Stream Info</h3>
                <div id="videoInfo" style="background: #111; padding: 10px; border: 1px solid #333; font-size: 11px; white-space: pre-wrap;">
                    Ready...
                </div>

                <div id="videoLog" class="log"></div>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">
            <h2>üîß Advanced</h2>
            <button onclick="listDevices()">List Media Devices</button>
            <button onclick="checkBrowser()">Check Browser Support</button>
            <button onclick="clearLogs()">Clear All Logs</button>
            <button onclick="hardRefresh()">Hard Refresh</button>
            <div id="advLog" class="log"></div>
        </div>
    </div>

    <script>
        const clientIdInput = document.getElementById('clientId');
        const roomIdInput = document.getElementById('roomId');
        const remoteVideo = document.getElementById('remoteVideo');
        const wsLog = document.getElementById('wsLog');
        const videoLog = document.getElementById('videoLog');
        const advLog = document.getElementById('advLog');
        const connectionStatus = document.getElementById('connectionStatus');
        const streamStatus = document.getElementById('streamStatus');
        const videoInfo = document.getElementById('videoInfo');

        let ws;
        let peerConnection;
        let clientId = 'test-viewer-' + Date.now();
        clientIdInput.value = clientId;

        function wsLog_add(msg, type = 'info') {
            const c = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            const el = document.createElement('div');
            el.style.color = c;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            wsLog.appendChild(el);
            wsLog.scrollTop = wsLog.scrollHeight;
            console.log(`[WS] ${msg}`);
        }

        function videoLog_add(msg, type = 'info') {
            const c = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            const el = document.createElement('div');
            el.style.color = c;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            videoLog.appendChild(el);
            videoLog.scrollTop = videoLog.scrollHeight;
            console.log(`[VIDEO] ${msg}`);
        }

        function advLog_add(msg, type = 'info') {
            const c = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            const el = document.createElement('div');
            el.style.color = c;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            advLog.appendChild(el);
            advLog.scrollTop = advLog.scrollHeight;
        }

        function updateConnectionStatus(msg, ok = false) {
            connectionStatus.className = 'status ' + (ok ? 'ok' : 'error');
            connectionStatus.textContent = msg;
        }

        function updateStreamStatus(msg, ok = false) {
            streamStatus.className = 'status ' + (ok ? 'ok' : 'info');
            streamStatus.textContent = msg;
        }

        async function connectTest() {
            try {
                const roomId = roomIdInput.value.trim();
                if (!roomId) { alert('Enter room ID'); return; }

                wsLog_add('Connecting to server...', 'info');
                updateConnectionStatus('Connecting...', false);

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${window.location.host}`);

                ws.onopen = () => {
                    wsLog_add('‚úì WebSocket connected!', 'success');
                    updateConnectionStatus('Connected to server ‚úì', true);

                    ws.send(JSON.stringify({
                        type: 'join',
                        roomId: roomId,
                        role: 'viewer',
                        clientId: clientId
                    }));
                    wsLog_add(`Joined room as viewer: ${roomId}`, 'info');
                };

                ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    wsLog_add(`‚Üê Received: ${data.type}`, 'info');
                    
                    if (data.type === 'joined') {
                        updateStreamStatus('Waiting for offer...', false);
                    } else if (data.type === 'offer') {
                        handleOffer(data.offer);
                    } else if (data.type === 'ice-candidate') {
                        if (peerConnection && data.candidate) {
                            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
                                .then(() => videoLog_add('‚úì ICE candidate added', 'success'))
                                .catch(e => videoLog_add('‚úó ICE error: ' + e.message, 'error'));
                        }
                    }
                };

                ws.onerror = (e) => {
                    wsLog_add('‚úó WebSocket error', 'error');
                    updateConnectionStatus('Connection error ‚úó', false);
                };

                ws.onclose = () => {
                    wsLog_add('Disconnected', 'error');
                    updateConnectionStatus('Disconnected', false);
                };

            } catch (e) {
                wsLog_add('‚úó Error: ' + e.message, 'error');
            }
        }

        async function handleOffer(offer) {
            try {
                videoLog_add('Creating peer connection...', 'info');
                
                if (!peerConnection) {
                    peerConnection = new RTCPeerConnection({
                        iceServers: [
                            { urls: ['stun:stun.l.google.com:19302'] },
                            { urls: ['stun:stun1.l.google.com:19302'] }
                        ]
                    });

                    peerConnection.ontrack = (event) => {
                        videoLog_add(`üé¨ ontrack fired! Kind: ${event.track.kind}`, 'success');
                        videoLog_add(`   Streams: ${event.streams.length}`, 'success');
                        
                        if (event.streams && event.streams.length > 0) {
                            videoLog_add('Attaching stream to video element...', 'info');
                            remoteVideo.srcObject = event.streams[0];
                            updateVideoInfo();
                            updateStreamStatus('Stream received ‚úì', true);
                        }
                    };

                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            ws.send(JSON.stringify({
                                type: 'ice-candidate',
                                roomId: roomIdInput.value,
                                to: 'broadcaster',
                                candidate: event.candidate
                            }));
                        }
                    };

                    peerConnection.onconnectionstatechange = () => {
                        videoLog_add(`Connection state: ${peerConnection.connectionState}`, 'info');
                    };
                }

                videoLog_add('Setting remote description (offer)...', 'info');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                videoLog_add('‚úì Remote description set', 'success');

                videoLog_add('Creating answer...', 'info');
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                videoLog_add('‚úì Answer created and set', 'success');

                ws.send(JSON.stringify({
                    type: 'answer',
                    roomId: roomIdInput.value,
                    to: 'broadcaster',
                    answer: answer
                }));
                videoLog_add('‚Üí Answer sent to broadcaster', 'success');

            } catch (e) {
                videoLog_add('‚úó Error: ' + e.message, 'error');
            }
        }

        function disconnectTest() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
                videoLog_add('Peer connection closed', 'info');
            }
            if (ws) {
                ws.close();
                wsLog_add('WebSocket closed', 'info');
            }
            remoteVideo.srcObject = null;
            updateStreamStatus('Disconnected', false);
        }

        function updateVideoInfo() {
            const v = remoteVideo;
            const stream = v.srcObject;
            let info = `Video Element:\n`;
            info += `  readyState: ${v.readyState}\n`;
            info += `  networkState: ${v.networkState}\n`;
            info += `  paused: ${v.paused}\n`;
            info += `  ended: ${v.ended}\n`;
            info += `  buffered: ${v.buffered.length} ranges\n`;
            info += `  videoWidth: ${v.videoWidth}\n`;
            info += `  videoHeight: ${v.videoHeight}\n`;
            
            if (stream) {
                info += `\nStream:\n`;
                info += `  active: ${stream.active}\n`;
                info += `  tracks: ${stream.getTracks().length}\n`;
                stream.getTracks().forEach((t, i) => {
                    info += `    [${i}] ${t.kind}: ${t.enabled ? 'on' : 'off'}\n`;
                });
            }
            
            videoInfo.textContent = info;
        }

        function testVideoProperties() {
            videoLog_add('Testing video properties...', 'info');
            updateVideoInfo();
            remoteVideo.play().catch(e => videoLog_add('Play error: ' + e.message, 'error'));
        }

        function toggleMuted() {
            remoteVideo.muted = !remoteVideo.muted;
            videoLog_add(`Muted: ${remoteVideo.muted}`, 'info');
        }

        async function listDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                advLog_add(`Found ${devices.length} media devices:`, 'success');
                devices.forEach((d, i) => {
                    advLog_add(`  [${i}] ${d.kind}: ${d.label}`, 'info');
                });
            } catch (e) {
                advLog_add('‚úó Error: ' + e.message, 'error');
            }
        }

        function checkBrowser() {
            advLog_add('Browser Capabilities:', 'info');
            advLog_add(`  WebRTC: ${!!window.RTCPeerConnection ? '‚úì' : '‚úó'}`, 'info');
            advLog_add(`  WebSocket: ${!!window.WebSocket ? '‚úì' : '‚úó'}`, 'info');
            advLog_add(`  getUserMedia: ${!!navigator.mediaDevices?.getUserMedia ? '‚úì' : '‚úó'}`, 'info');
            advLog_add(`  getDisplayMedia: ${!!navigator.mediaDevices?.getDisplayMedia ? '‚úì' : '‚úó'}`, 'info');
            advLog_add(`  RTCPeerConnection: ${typeof RTCPeerConnection}`, 'info');
        }

        function clearLogs() {
            wsLog.innerHTML = '';
            videoLog.innerHTML = '';
            advLog.innerHTML = '';
        }

        function hardRefresh() {
            location.reload(true);
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkBrowser();
            listDevices();
        });
    </script>
</body>
</html>
